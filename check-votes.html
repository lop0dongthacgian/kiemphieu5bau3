<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm phi·∫øu b·∫ßu c·ª≠ 5 b·∫ßu 3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background-color: #f0f2f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #1E29FF; text-align: center; }
        h2 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 5px; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        input[type="number"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 4px; font-weight: bold; transition: background-color 0.3s; }
        button:hover { background-color: #45a049; }
        button.confirmed { background-color: #808080; }
        button.confirmed:hover { background-color: #707070; }
        .vote-table { margin: 20px 0; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .check-type { background-color: #e7f3ff; padding: 10px; margin-bottom: 10px; border-left: 2px solid #2196F3; border-right: 2px solid #2196F3; font-weight: bold; }
        .error-message { color: #d32f2f; background-color: #ffebee; padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
        .summary { background-color: #e9f7ef; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .btn-center { text-align: center; margin-top: 15px; }
        .combined-table td { text-align: center; }
        .combined-table input { text-align: center; }
        .export-btn { background-color: #28a745; margin-top: 20px; padding: 15px 30px; font-size: 16px; }
        .export-btn:hover { background-color: #218838; }
        .export-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>M√ÅY T√çNH KI·ªÇM PHI·∫æU B·∫¶U C·ª¨</h1>
        
        <div class="vote-table">
            <h2>Th√¥ng tin chung</h2>
            <table>
                <tr>
                    <td><strong>T·ªïng s·ªë c·ª≠ tri c·ªßa ƒë∆°n v·ªã b·∫ßu c·ª≠:</strong></td>
                    <td><input type="number" id="totalVotersUnit" value="0" oninput="onInputChange('general')"></td>
                    <td><strong>S·ªë c·ª≠ tri ƒë√£ tham gia b·ªè phi·∫øu:</strong></td>
                    <td><input type="number" id="actualVoters" value="0" oninput="updateCalculations(); onInputChange('general')"></td>
                </tr>
                <tr>
                    <td colspan="3"><strong>T·ª∑ l·ªá c·ª≠ tri tham gia:</strong></td>
                    <td><strong id="voterTurnout" style="color: blue; font-size: 1.1em;">0%</strong></td>
                </tr>
                <tr>
                    <td><strong>S·ªë phi·∫øu ph√°t ra:</strong></td>
                    <td><input type="number" id="issuedBallots" value="0" oninput="onInputChange('general')"></td>
                    <td><strong>S·ªë phi·∫øu thu v√†o:</strong></td>
                    <td><input type="number" id="collectedBallots" value="0" oninput="updateCalculations(); onInputChange('general')"></td>
                </tr>
                <tr>
                    <td><strong>S·ªë phi·∫øu kh√¥ng h·ª£p l·ªá:</strong></td>
                    <td><input type="number" id="invalidVotes" value="0" oninput="updateCalculations(); onInputChange('general')"></td>
                    <td><strong>S·ªë phi·∫øu h·ª£p l·ªá:</strong></td>
                    <td><strong id="validVotesCalc" style="color: green; font-size: 1.2em;">0</strong></td>
                </tr>
                <tr>
                    <td colspan="3"><strong>T·ª∑ l·ªá phi·∫øu h·ª£p l·ªá:</strong></td>
                    <td><strong id="validVotesRate" style="color: green; font-size: 1.1em;">0%</strong></td>
                </tr>
                <tr>
                    <td colspan="3"><strong>T·ª∑ l·ªá phi·∫øu kh√¥ng h·ª£p l·ªá:</strong></td>
                    <td><strong id="invalidVotesRate" style="color: red; font-size: 1.1em;">0%</strong></td>
                </tr>
            </table>
            <div class="btn-center">
                <button id="btn-general" onclick="checkVotes('general')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button>
            </div>
        </div>

        <div class="vote-table">
            <h2>1. KI·ªÇM XU√îI: G·∫°ch 4 (B·∫ßu 1) v√† G·∫°ch 3 (B·∫ßu 2)</h2>
            <div class="check-type">Nh·∫≠p s·ªë phi·∫øu ƒê∆Ø·ª¢C B·∫¶U cho t·ª´ng ng∆∞·ªùi (t·ªïng c·ªông c·∫£ 2 lo·∫°i phi·∫øu)</div>
            <table class="combined-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Ng∆∞·ªùi ƒë∆∞·ª£c b·∫ßu</th>
                        <th>S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu<br>(G·∫°ch 4 + G·∫°ch 3)</th>
                    </tr>
                </thead>
                <tbody id="body-combined"></tbody>
            </table>
            <div class="btn-center">
                <button id="btn-combined" onclick="checkVotes('combined')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button>
            </div>
            <div id="result_combined"></div>
        </div>

        <div class="vote-table">
            <h2>2. KI·ªÇM NG∆Ø·ª¢C: G·∫°ch 2 (B·∫ßu 3)</h2>
            <div class="check-type">Nh·∫≠p s·ªë phi·∫øu theo c·∫∑p B·ªä G·∫†CH</div>
            <table id="table-g2">
                <thead><tr><th>STT</th><th>C·∫∑p ·ª©ng vi√™n B·ªä G·∫†CH</th><th>S·ªë phi·∫øu</th></tr></thead>
                <tbody id="body-g2"></tbody>
            </table>
            <div class="btn-center">
                <button id="btn-g2" onclick="checkVotes('g2')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button>
            </div>
            <div id="result_g2"></div>
        </div>

        <div style="text-align: center; margin: 40px 0;">
            <button onclick="calculateTotalResults()" style="background-color: #1E29FF; font-size: 15px; padding: 20px 40px;">
                <span style="font-size: 16px; font-weight: bold; text-transform: uppercase;">XEM T·ªîNG K·∫æT CU·ªêI C√ôNG</span><br>
                <span style="font-size: 12px;">(Sau khi ƒë√£ x√°c nh·∫≠n xong 3 m·ª•c tr√™n)</span>
            </button>
        </div>

        <div id="totalResults" class="summary" style="display: none;">
            <h2>K·∫æT QU·∫¢ T·ªîNG H·ª¢P</h2>
            <div id="totalError" class="error-message"></div>
            <table id="resultsTable">
                <thead><tr><th>·ª®ng vi√™n</th><th>S·ªë phi·∫øu ƒê∆Ø·ª¢C B·∫¶U</th><th>T·ª∑ l·ªá (%)</th></tr></thead>
                <tbody></tbody>
            </table>
            
            <div class="btn-center">
                <button class="export-btn" onclick="exportToExcel()">
                    üìä XU·∫§T K·∫æT QU·∫¢ RA FILE EXCEL
                </button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // D·ªØ li·ªáu ·ª©ng vi√™n ƒë∆∞·ª£c load t·ª´ config.js

        // Khai b√°o c√°c t·ªï h·ª£p c·∫∑p
        const pairs = [
            {ids: ['A','B']}, {ids: ['A','C']}, {ids: ['A','D']}, {ids: ['A','E']},
            {ids: ['B','C']}, {ids: ['B','D']}, {ids: ['B','E']},
            {ids: ['C','D']}, {ids: ['C','E']}, {ids: ['D','E']}
        ];

        // Tr·∫°ng th√°i x√°c nh·∫≠n v√† l∆∞u d·ªØ li·ªáu
        let confirmedStatus = {
            'general': false,
            'combined': false,
            'g2': false
        };
        
        let savedData = {
            'general': {},
            'combined': {},
            'g2': {}
        };

        let finalResults = {};

        // T·ª± ƒë·ªông ƒë·ªï t√™n v√†o b·∫£ng khi m·ªü trang
        window.onload = function() {
            const bodyCombined = document.getElementById('body-combined');
            candidateKeys.forEach((key, index) => {
                bodyCombined.innerHTML += `
                    <tr>
                        <td>${index+1}</td>
                        <td>${candidates[key]}</td>
                        <td><input type="number" id="vote_combined_${key}" value="0" oninput="onInputChange('combined')"></td>
                    </tr>`;
            });

            const bodyG2 = document.getElementById('body-g2');
            pairs.forEach((pair, index) => {
                const names = pair.ids.map(id => candidates[id]).join(' v√† ');
                bodyG2.innerHTML += `
                    <tr>
                        <td>${index+1}</td>
                        <td>${names}</td>
                        <td><input type="number" id="vote_g2_${index}" value="0" oninput="onInputChange('g2')"></td>
                    </tr>`;
            });

            updateCalculations();
        };

        // C·∫≠p nh·∫≠t c√°c t√≠nh to√°n
        document.getElementById('totalVotersUnit').addEventListener('input', updateCalculations);
        
        function updateCalculations() {
            const totalVotersUnit = parseInt(document.getElementById('totalVotersUnit').value) || 0;
            const actualVoters = parseInt(document.getElementById('actualVoters').value) || 0;
            const collectedBallots = parseInt(document.getElementById('collectedBallots').value) || 0;
            const invalidVotes = parseInt(document.getElementById('invalidVotes').value) || 0;
            
            // T√≠nh phi·∫øu h·ª£p l·ªá = phi·∫øu thu v√†o - phi·∫øu kh√¥ng h·ª£p l·ªá
            const validVotes = collectedBallots - invalidVotes;
            document.getElementById('validVotesCalc').textContent = validVotes >= 0 ? validVotes : 0;
            
            // T·ª∑ l·ªá c·ª≠ tri tham gia
            const turnout = totalVotersUnit > 0 ? ((actualVoters / totalVotersUnit) * 100).toFixed(2) : 0;
            document.getElementById('voterTurnout').textContent = turnout + '%';
            
            // T·ª∑ l·ªá phi·∫øu h·ª£p l·ªá
            const validRate = collectedBallots > 0 ? ((validVotes / collectedBallots) * 100).toFixed(2) : 0;
            document.getElementById('validVotesRate').textContent = validRate + '%';
            
            // T·ª∑ l·ªá phi·∫øu kh√¥ng h·ª£p l·ªá
            const invalidRate = collectedBallots > 0 ? ((invalidVotes / collectedBallots) * 100).toFixed(2) : 0;
            document.getElementById('invalidVotesRate').textContent = invalidRate + '%';
        }

        // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng nh·∫≠p d·ªØ li·ªáu
        function onInputChange(type) {
            if (confirmedStatus[type]) {
                confirmedStatus[type] = false;
                const btn = document.getElementById('btn-' + type);
                btn.classList.remove('confirmed');
                if (type === 'general') {
                    btn.textContent = 'X√°c nh·∫≠n ƒë√£ nh·∫≠p xong';
                } else if (type === 'combined') {
                    btn.textContent = 'X√°c nh·∫≠n ƒë√£ nh·∫≠p xong';
                } else {
                    btn.textContent = 'X√°c nh·∫≠n ƒë√£ nh·∫≠p xong';
                }
            }
        }

        // X√°c nh·∫≠n d·ªØ li·ªáu
        function checkVotes(type) {
            if (type === 'general') {
                savedData.general = {
                    totalVotersUnit: parseInt(document.getElementById('totalVotersUnit').value) || 0,
                    actualVoters: parseInt(document.getElementById('actualVoters').value) || 0,
                    issuedBallots: parseInt(document.getElementById('issuedBallots').value) || 0,
                    collectedBallots: parseInt(document.getElementById('collectedBallots').value) || 0,
                    invalidVotes: parseInt(document.getElementById('invalidVotes').value) || 0,
                    validVotes: parseInt(document.getElementById('validVotesCalc').textContent) || 0
                };
            } else if (type === 'combined') {
                candidateKeys.forEach(key => {
                    savedData.combined[key] = parseInt(document.getElementById(`vote_combined_${key}`).value) || 0;
                });
            } else if (type === 'g2') {
                pairs.forEach((pair, index) => {
                    savedData.g2[index] = parseInt(document.getElementById(`vote_g2_${index}`).value) || 0;
                });
            }
            
            confirmedStatus[type] = true;
            const btn = document.getElementById('btn-' + type);
            btn.classList.add('confirmed');
            btn.textContent = '‚úì ƒê√£ x√°c nh·∫≠n';
            
            let message = '';
            if (type === 'general') {
                message = "ƒê√£ l∆∞u d·ªØ li·ªáu Th√¥ng tin chung";
            } else if (type === 'combined') {
                message = "ƒê√£ l∆∞u d·ªØ li·ªáu Ki·ªÉm xu√¥i (G·∫°ch 4 + G·∫°ch 3)";
            } else {
                message = "ƒê√£ l∆∞u d·ªØ li·ªáu G·∫°ch 2";
            }
            alert(message + ". Nh·∫•n 'XEM T·ªîNG K·∫æT' ƒë·ªÉ xem k·∫øt qu·∫£ cu·ªëi c√πng.");
        }

        // T√≠nh t·ªïng k·∫øt
        function calculateTotalResults() {
            // L·∫•y d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ ƒë√£ l∆∞u
            const collectedBallots = savedData.general.collectedBallots || 0;
            const invalidVotes = savedData.general.invalidVotes || 0;
            const validVotes = savedData.general.validVotes || 0;
            
            finalResults = { 'A': 0, 'B': 0, 'C': 0, 'D': 0, 'E': 0 };

            // 1. T√≠nh t·ª´ d·ªØ li·ªáu ƒë√£ l∆∞u c·ªßa G·∫°ch 4 + G·∫°ch 3 (Ki·ªÉm xu√¥i)
            candidateKeys.forEach(key => {
                finalResults[key] += savedData.combined[key] || 0;
            });

            // 2. T√≠nh G·∫°ch 2 (Ki·ªÉm ng∆∞·ª£c: Phi·∫øu ƒë∆∞·ª£c b·∫ßu = T·ªïng h·ª£p l·ªá - Phi·∫øu b·ªã g·∫°ch)
            pairs.forEach((pair, index) => {
                const rejectedVal = savedData.g2[index] || 0;
                const electedVal = validVotes - rejectedVal;
                candidateKeys.forEach(id => {
                    if (!pair.ids.includes(id)) finalResults[id] += electedVal;
                });
            });

            // Hi·ªÉn th·ªã b·∫£ng k·∫øt qu·∫£
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';
            const sorted = Object.keys(finalResults).sort((a,b) => finalResults[b] - finalResults[a]);
            
            sorted.forEach(key => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = candidates[key];
                row.insertCell(1).textContent = finalResults[key];
                const pct = validVotes > 0 ? ((finalResults[key] / (validVotes * 3)) * 100).toFixed(2) : 0;
                row.insertCell(2).textContent = pct + '%';
            });
            
            document.getElementById('totalResults').style.display = 'block';
            document.getElementById('totalResults').scrollIntoView({ behavior: 'smooth' });
        }

        // Xu·∫•t file Excel
        function exportToExcel() {
            // L·∫•y d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ ƒë√£ l∆∞u
            const totalVotersUnit = savedData.general.totalVotersUnit || 0;
            const actualVoters = savedData.general.actualVoters || 0;
            const issuedBallots = savedData.general.issuedBallots || 0;
            const collectedBallots = savedData.general.collectedBallots || 0;
            const invalidVotes = savedData.general.invalidVotes || 0;
            const validVotes = savedData.general.validVotes || 0;
            
            const voterTurnout = totalVotersUnit > 0 ? ((actualVoters / totalVotersUnit) * 100).toFixed(2) : 0;
            const validRate = collectedBallots > 0 ? ((validVotes / collectedBallots) * 100).toFixed(2) : 0;
            const invalidRate = collectedBallots > 0 ? ((invalidVotes / collectedBallots) * 100).toFixed(2) : 0;

            // T·∫°o workbook
            const wb = XLSX.utils.book_new();

            // Sheet 1: B√°o c√°o t·ªïng h·ª£p
            const summaryData = [
                ['BI√äN B·∫¢N KI·ªÇM PHI·∫æU B·∫¶U C·ª¨'],
                ['Ng√†y xu·∫•t: ' + new Date().toLocaleString('vi-VN')],
                [],
                ['TH√îNG TIN B·∫¶U C·ª¨'],
                ['S·ªë c·ª≠ tri ƒë√£ tham gia b·ªè phi·∫øu:', actualVoters + ' ng∆∞·ªùi'],
                ['T·ª∑ l·ªá c·ª≠ tri ƒë√£ tham gia b·ªè phi·∫øu so v·ªõi t·ªïng s·ªë c·ª≠ tri c·ªßa ƒë∆°n v·ªã b·∫ßu c·ª≠:', voterTurnout + '%'],
                ['S·ªë phi·∫øu ph√°t ra:', issuedBallots + ' phi·∫øu'],
                ['S·ªë phi·∫øu thu v√†o:', collectedBallots + ' phi·∫øu'],
                ['S·ªë phi·∫øu h·ª£p l·ªá:', validVotes + ' phi·∫øu', 'T·ª∑ l·ªá so v·ªõi t·ªïng s·ªë phi·∫øu thu v√†o: ' + validRate + '%'],
                ['S·ªë phi·∫øu kh√¥ng h·ª£p l·ªá:', invalidVotes + ' phi·∫øu', 'T·ª∑ l·ªá so v·ªõi t·ªïng s·ªë phi·∫øu thu v√†o: ' + invalidRate + '%'],
                [],
                ['K·∫æT QU·∫¢ B·∫¶U C·ª¨'],
                ['S·ªë phi·∫øu b·∫ßu cho m·ªói ng∆∞·ªùi ·ª©ng c·ª≠ nh∆∞ sau:'],
                []
            ];

            // Th√™m d·ªØ li·ªáu ·ª©ng vi√™n (s·∫Øp x·∫øp theo s·ªë phi·∫øu gi·∫£m d·∫ßn)
            const sorted = Object.keys(finalResults).sort((a,b) => finalResults[b] - finalResults[a]);
            sorted.forEach((key, index) => {
                const votePct = validVotes > 0 ? ((finalResults[key] / (validVotes * 3)) * 100).toFixed(2) : 0;
                summaryData.push([
                    (index + 1) + '. ' + candidates[key],
                    'ƒë∆∞·ª£c ' + finalResults[key] + ' phi·∫øu/' + (validVotes * 3) + ' phi·∫øu h·ª£p l·ªá',
                    votePct + '%'
                ]);
            });

            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            
            // ƒê·ªãnh d·∫°ng ƒë·ªô r·ªông c·ªôt
            ws1['!cols'] = [
                { wch: 50 },
                { wch: 35 },
                { wch: 15 }
            ];

            XLSX.utils.book_append_sheet(wb, ws1, 'Bi√™n b·∫£n t·ªïng h·ª£p');

            // Sheet 2: B·∫£ng th·ªëng k√™ chi ti·∫øt
            const detailTable = [
                ['B·∫¢NG TH·ªêNG K√ä CHI TI·∫æT'],
                [],
                ['STT', '·ª®ng vi√™n', 'S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu', 'T·ª∑ l·ªá (%)']
            ];

            sorted.forEach((key, index) => {
                const votePct = validVotes > 0 ? ((finalResults[key] / (validVotes * 3)) * 100).toFixed(2) : 0;
                detailTable.push([
                    index + 1,
                    candidates[key],
                    finalResults[key],
                    votePct
                ]);
            });

            const ws2 = XLSX.utils.aoa_to_sheet(detailTable);
            ws2['!cols'] = [{ wch: 5 }, { wch: 30 }, { wch: 20 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws2, 'Th·ªëng k√™ chi ti·∫øt');

            // Sheet 3: Chi ti·∫øt ki·ªÉm xu√¥i
            const detailData1 = [
                ['CHI TI·∫æT KI·ªÇM XU√îI (G·∫°ch 4 + G·∫°ch 3)'],
                [],
                ['STT', '·ª®ng vi√™n', 'S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu']
            ];

            candidateKeys.forEach((key, index) => {
                detailData1.push([
                    index + 1,
                    candidates[key],
                    savedData.combined[key] || 0
                ]);
            });

            const ws3 = XLSX.utils.aoa_to_sheet(detailData1);
            ws3['!cols'] = [{ wch: 5 }, { wch: 25 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws3, 'Chi ti·∫øt Ki·ªÉm xu√¥i');

            // Sheet 4: Chi ti·∫øt ki·ªÉm ng∆∞·ª£c
            const detailData2 = [
                ['CHI TI·∫æT KI·ªÇM NG∆Ø·ª¢C (G·∫°ch 2)'],
                [],
                ['STT', 'C·∫∑p ·ª©ng vi√™n b·ªã g·∫°ch', 'S·ªë phi·∫øu']
            ];

            pairs.forEach((pair, index) => {
                const names = pair.ids.map(id => candidates[id]).join(' v√† ');
                detailData2.push([
                    index + 1,
                    names,
                    savedData.g2[index] || 0
                ]);
            });

            const ws4 = XLSX.utils.aoa_to_sheet(detailData2);
            ws4['!cols'] = [{ wch: 5 }, { wch: 30 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws4, 'Chi ti·∫øt Ki·ªÉm ng∆∞·ª£c');

            // Xu·∫•t file
            const fileName = `Bien_ban_kiem_phieu_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert('ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!');
        }
    </script>
</body>
</html>
