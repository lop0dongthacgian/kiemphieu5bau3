<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ki·ªÉm phi·∫øu b·∫ßu c·ª≠ 5 b·∫ßu 3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background-color: #f0f2f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #1E29FF; text-align: center; }
        h2 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 5px; text-align: center; }
        h3 { color: #1a237e; margin-top: 20px; padding: 10px; background-color: #e3f2fd; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        input[type="number"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 4px; font-weight: bold; transition: background-color 0.3s; }
        button:hover { background-color: #45a049; }
        button.confirmed { background-color: #808080; }
        button.confirmed:hover { background-color: #707070; }
        .vote-table { margin: 20px 0; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; }
        .check-type { background-color: #e7f3ff; padding: 10px; margin-bottom: 10px; border-left: 2px solid #2196F3; border-right: 2px solid #2196F3; font-weight: bold; }
        .error-message { color: #d32f2f; background-color: #ffebee; padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
        .summary { background-color: #e9f7ef; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .btn-center { text-align: center; margin-top: 15px; }
        .combined-table td { text-align: center; }
        .combined-table input { text-align: center; }
        .export-btn { background-color: #28a745; margin-top: 20px; padding: 15px 30px; font-size: 16px; }
        .export-btn:hover { background-color: #218838; }
        .export-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .section-counter { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .counter-box { background: #f5f5f5; padding: 10px 15px; border-radius: 5px; font-weight: bold; color: #333; }
        .total-box { background: #e8f5e9; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>M√ÅY T√çNH KI·ªÇM PHI·∫æU B·∫¶U C·ª¨ (5 B·∫¶U 3)</h1>
        
        <div class="vote-table">
            <h2>TH√îNG TIN CHUNG</h2>
            <table>
                <tr>
                    <td><strong>T·ªïng s·ªë c·ª≠ tri c·ªßa ƒë∆°n v·ªã b·∫ßu c·ª≠:</strong></td>
                    <td><input type="number" id="totalVotersUnit" value="" oninput="onInputChange('general')"></td>
                    <td><strong>S·ªë c·ª≠ tri ƒë√£ tham gia b·ªè phi·∫øu:</strong></td>
                    <td><input type="number" id="actualVoters" value="" oninput="updateCalculations(); onInputChange('general')"></td>
                </tr>
                <tr>
                    <td colspan="3"><strong>T·ª∑ l·ªá c·ª≠ tri tham gia:</strong></td>
                    <td><strong id="voterTurnout" style="color: blue; font-size: 1.1em;">0%</strong></td>
                </tr>
                <tr>
                    <td><strong>S·ªë phi·∫øu ph√°t ra:</strong></td>
                    <td><input type="number" id="issuedBallots" value="" oninput="onInputChange('general')"></td>
                    <td><strong>S·ªë phi·∫øu thu v√†o:</strong></td>
                    <td><input type="number" id="collectedBallots" value="" oninput="updateCalculations(); onInputChange('general')"></td>
                </tr>
                <tr>
                    <td><strong>S·ªë phi·∫øu kh√¥ng h·ª£p l·ªá:</strong></td>
                    <td><input type="number" id="invalidVotes" value="" oninput="updateCalculations(); onInputChange('general')"></td>
                    <td><strong>S·ªë phi·∫øu h·ª£p l·ªá:</strong></td>
                    <td><strong id="validVotesCalc" style="color: green; font-size: 1.2em;">0</strong></td>
                </tr>
                <tr>
                    <td colspan="3"><strong>T·ª∑ l·ªá phi·∫øu h·ª£p l·ªá:</strong></td>
                    <td><strong id="validVotesRate" style="color: green; font-size: 1.1em;">0%</strong></td>
                </tr>
                <tr>
                    <td colspan="3"><strong>T·ª∑ l·ªá phi·∫øu kh√¥ng h·ª£p l·ªá:</strong></td>
                    <td><strong id="invalidVotesRate" style="color: red; font-size: 1.1em;">0%</strong></td>
                </tr>
            </table>
            <div class="btn-center">
                <button id="btn-general" onclick="checkVotes('general')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button>
            </div>
        </div>

        <!-- PH·∫¶N 1: B·∫¶U 1 (G·∫°ch 4) -->
        <div class="vote-table">
            <div class="section-counter">
                <h3>PHI·∫æU B·∫¶U 1 NG∆Ø·ªúI (G·∫†CH 4)</h3>
                <div class="counter-box">
                    S·ªë phi·∫øu lo·∫°i n√†y: <input type="number" id="ballotType1Count" value="" style="width: 80px; margin-left: 10px;" oninput="updateType1Total(); onInputChange('type1')">
                </div>
            </div>
            <div class="check-type">Nh·∫≠p s·ªë phi·∫øu ƒê∆Ø·ª¢C B·∫¶U cho t·ª´ng ng∆∞·ªùi (m·ªói phi·∫øu ch·ªâ b·∫ßu 1 ng∆∞·ªùi)</div>
            <table class="combined-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Ng∆∞·ªùi ƒë∆∞·ª£c b·∫ßu</th>
                        <th>S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu</th>
                    </tr>
                </thead>
                <tbody id="body-type1"></tbody>
            </table>
            <div class="total-box" id="type1Total">T·ªïng phi·∫øu b·∫ßu lo·∫°i n√†y: <span id="type1Sum">0</span></div>
            <div class="btn-center">
                <button id="btn-type1" onclick="checkVotes('type1')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button>
            </div>
        </div>

        <!-- PH·∫¶N 2: B·∫¶U 2 (G·∫°ch 3) -->
        <div class="vote-table">
            <div class="section-counter">
                <h3>PHI·∫æU B·∫¶U 2 NG∆Ø·ªúI (G·∫†CH 3)</h3>
                <div class="counter-box">
                    S·ªë phi·∫øu lo·∫°i n√†y: <input type="number" id="ballotType2Count" value="" style="width: 80px; margin-left: 10px;" oninput="updateType2Total(); onInputChange('type2')">
                </div>
            </div>
            <div class="check-type">Nh·∫≠p s·ªë phi·∫øu ƒê∆Ø·ª¢C B·∫¶U cho t·ª´ng ng∆∞·ªùi (m·ªói phi·∫øu b·∫ßu 2 ng∆∞·ªùi)</div>
            <table class="combined-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Ng∆∞·ªùi ƒë∆∞·ª£c b·∫ßu</th>
                        <th>S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu</th>
                    </tr>
                </thead>
                <tbody id="body-type2"></tbody>
            </table>
            <div class="total-box" id="type2Total">T·ªïng phi·∫øu b·∫ßu lo·∫°i n√†y: <span id="type2Sum">0</span> (l√Ω thuy·∫øt: <span id="type2Expected">0</span>)</div>
            <div class="btn-center">
                <button id="btn-type2" onclick="checkVotes('type2')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button>
            </div>
        </div>

        <!-- PH·∫¶N 3: B·∫¶U 3 (G·∫°ch 2) -->
        <div class="vote-table">
            <div class="section-counter">
                <h3>PHI·∫æU B·∫¶U 3 NG∆Ø·ªúI (G·∫†CH 2)</h3>
                <div class="counter-box">
                    S·ªë phi·∫øu lo·∫°i n√†y: <input type="number" id="ballotType3Count" value="" style="width: 80px; margin-left: 10px;" oninput="updateCalculations(); onInputChange('type3')">
                </div>
            </div>
            <div class="check-type">Nh·∫≠p s·ªë phi·∫øu theo c·∫∑p B·ªä G·∫†CH (m·ªói phi·∫øu g·∫°ch 2 ng∆∞·ªùi, b·∫ßu 3 ng∆∞·ªùi c√≤n l·∫°i)</div>
            <table id="table-type3">
                <thead><tr><th>STT</th><th>C·∫∑p ·ª©ng vi√™n B·ªä G·∫†CH</th><th>S·ªë phi·∫øu</th></tr></thead>
                <tbody id="body-type3"></tbody>
            </table>
            <div class="btn-center">
                <button id="btn-type3" onclick="checkVotes('type3')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button>
            </div>
        </div>

        <!-- T·ªîNG K·∫æT T·∫†M -->
        <div class="vote-table" style="background-color: #fff8e1;">
            <h2>T·ªîNG H·ª¢P T·∫†M TH·ªúI</h2>
            <table>
                <tr>
                    <td><strong>T·ªïng phi·∫øu h·ª£p l·ªá (t·ª´ th√¥ng tin chung):</strong></td>
                    <td><strong id="totalValidVotes" style="color: blue;">0</strong></td>
                </tr>
                <tr>
                    <td><strong>T·ªïng phi·∫øu 3 lo·∫°i ƒë√£ nh·∫≠p:</strong></td>
                    <td><strong id="totalEnteredVotes" style="color: green;">0</strong></td>
                </tr>
                <tr>
                    <td><strong>Ch√™nh l·ªách:</strong></td>
                    <td><strong id="voteDifference" style="color: red;">0</strong></td>
                </tr>
                <tr>
                    <td><strong>Tr·∫°ng th√°i:</strong></td>
                    <td><strong id="consistencyStatus">Ch∆∞a ki·ªÉm tra</strong></td>
                </tr>
            </table>
        </div>

        <!-- N√öT T√çNH TO√ÅN CU·ªêI C√ôNG -->
        <div style="text-align: center; margin: 40px 0;">
            <button onclick="calculateTotalResults()" style="background-color: #1E29FF; font-size: 15px; padding: 20px 40px;">
                <span style="font-size: 16px; font-weight: bold; text-transform: uppercase;">T√çNH TO√ÅN K·∫æT QU·∫¢ CU·ªêI C√ôNG</span><br>
                <span style="font-size: 12px;">(Sau khi ƒë√£ x√°c nh·∫≠n xong t·∫•t c·∫£ c√°c ph·∫ßn)</span>
            </button>
        </div>

        <!-- K·∫æT QU·∫¢ CU·ªêI C√ôNG -->
        <div id="totalResults" class="summary" style="display: none;">
            <h2>K·∫æT QU·∫¢ T·ªîNG H·ª¢P CU·ªêI C√ôNG</h2>
            <div id="totalError" class="error-message"></div>
            <table id="resultsTable">
                <thead><tr><th>STT</th><th>·ª®ng vi√™n</th><th>S·ªë phi·∫øu ƒê∆Ø·ª¢C B·∫¶U</th><th>T·ª∑ l·ªá (%)</th></tr></thead>
                <tbody></tbody>
            </table>
            
            <div class="btn-center">
                <button class="export-btn" onclick="exportToExcel()">
                    üìä XU·∫§T K·∫æT QU·∫¢ RA FILE EXCEL
                </button>
            </div>
        </div>
    </div>

    <script>
       
        const candidates = {
  'A': 'Nguy·ªÖn VƒÉn An',
  'B': 'Tr·∫ßn Kim Bi√™n', 
  'C': 'Ho√†ng Th·ªã Ch√¢u',
  'D': 'L√™ T·∫•n D≈©ng',
  'E': 'B√πi Th·ªã Thanh Em'
};

const candidateKeys = Object.keys(candidates);
const candidateCount = candidateKeys.length;

        // T·ªï h·ª£p c·∫∑p cho ph·∫ßn b·∫ßu 3
        const pairs = [
            {ids: ['A','B']}, {ids: ['A','C']}, {ids: ['A','D']}, {ids: ['A','E']},
            {ids: ['B','C']}, {ids: ['B','D']}, {ids: ['B','E']},
            {ids: ['C','D']}, {ids: ['C','E']}, {ids: ['D','E']}
        ];

        // Tr·∫°ng th√°i x√°c nh·∫≠n v√† l∆∞u d·ªØ li·ªáu
        let confirmedStatus = {
            'general': false, 'type1': false, 'type2': false, 'type3': false
        };
        
        let savedData = {
            'general': {},
            'type1': {},
            'type2': {},
            'type3': {}
        };

        let finalResults = {};

        // T·ª± ƒë·ªông ƒë·ªï d·ªØ li·ªáu khi m·ªü trang
        window.onload = function() {
            // Ph·∫ßn b·∫ßu 1
            const bodyType1 = document.getElementById('body-type1');
            candidateKeys.forEach((key, index) => {
                bodyType1.innerHTML += `
                    <tr>
                        <td>${index+1}</td>
                        <td>${candidates[key]}</td>
                        <td><input type="number" id="vote_type1_${key}" value="" oninput="updateType1Total(); onInputChange('type1')"></td>
                    </tr>`;
            });

            // Ph·∫ßn b·∫ßu 2
            const bodyType2 = document.getElementById('body-type2');
            candidateKeys.forEach((key, index) => {
                bodyType2.innerHTML += `
                    <tr>
                        <td>${index+1}</td>
                        <td>${candidates[key]}</td>
                        <td><input type="number" id="vote_type2_${key}" value="" oninput="updateType2Total(); onInputChange('type2')"></td>
                    </tr>`;
            });

            // Ph·∫ßn b·∫ßu 3
            const bodyType3 = document.getElementById('body-type3');
            pairs.forEach((pair, index) => {
                const names = pair.ids.map(id => candidates[id]).join(' v√† ');
                bodyType3.innerHTML += `
                    <tr>
                        <td>${index+1}</td>
                        <td>${names}</td>
                        <td><input type="number" id="vote_type3_${index}" value="" oninput="onInputChange('type3')"></td>
                    </tr>`;
            });

            updateCalculations();
        };

        // C·∫≠p nh·∫≠t t·ªïng phi·∫øu b·∫ßu 1
        function updateType1Total() {
            let sum = 0;
            candidateKeys.forEach(key => {
                sum += parseInt(document.getElementById(`vote_type1_${key}`).value) || 0;
            });
            document.getElementById('type1Sum').textContent = sum;
            
            const ballotCount = parseInt(document.getElementById('ballotType1Count').value) || 0;
            if (ballotCount > 0 && sum !== ballotCount) {
                document.getElementById('type1Total').style.backgroundColor = '#ffebee';
            } else {
                document.getElementById('type1Total').style.backgroundColor = '#e8f5e9';
            }
            
            updateTotalEnteredVotes();
        }

        // C·∫≠p nh·∫≠t t·ªïng phi·∫øu b·∫ßu 2
        function updateType2Total() {
            let sum = 0;
            candidateKeys.forEach(key => {
                sum += parseInt(document.getElementById(`vote_type2_${key}`).value) || 0;
            });
            document.getElementById('type2Sum').textContent = sum;
            
            const ballotCount = parseInt(document.getElementById('ballotType2Count').value) || 0;
            const expected = ballotCount * 2; // M·ªói phi·∫øu b·∫ßu 2 ng∆∞·ªùi
            document.getElementById('type2Expected').textContent = expected;
            
            if (expected > 0 && sum !== expected) {
                document.getElementById('type2Total').style.backgroundColor = '#ffebee';
            } else {
                document.getElementById('type2Total').style.backgroundColor = '#e8f5e9';
            }
            
            updateTotalEnteredVotes();
        }

        // C·∫≠p nh·∫≠t c√°c t√≠nh to√°n chung
        function updateCalculations() {
            const totalVotersUnit = parseInt(document.getElementById('totalVotersUnit').value) || 0;
            const actualVoters = parseInt(document.getElementById('actualVoters').value) || 0;
            const collectedBallots = parseInt(document.getElementById('collectedBallots').value) || 0;
            const invalidVotes = parseInt(document.getElementById('invalidVotes').value) || 0;
            
            // T√≠nh phi·∫øu h·ª£p l·ªá
            const validVotes = collectedBallots - invalidVotes;
            document.getElementById('validVotesCalc').textContent = validVotes >= 0 ? validVotes : 0;
            document.getElementById('totalValidVotes').textContent = validVotes;
            
            // T·ª∑ l·ªá c·ª≠ tri tham gia
            const turnout = totalVotersUnit > 0 ? ((actualVoters / totalVotersUnit) * 100).toFixed(2) : 0;
            document.getElementById('voterTurnout').textContent = turnout + '%';
            
            // T·ª∑ l·ªá phi·∫øu h·ª£p l·ªá
            const validRate = collectedBallots > 0 ? ((validVotes / collectedBallots) * 100).toFixed(2) : 0;
            document.getElementById('validVotesRate').textContent = validRate + '%';
            
            // T·ª∑ l·ªá phi·∫øu kh√¥ng h·ª£p l·ªá
            const invalidRate = collectedBallots > 0 ? ((invalidVotes / collectedBallots) * 100).toFixed(2) : 0;
            document.getElementById('invalidVotesRate').textContent = invalidRate + '%';
            
            updateTotalEnteredVotes();
        }

        // C·∫≠p nh·∫≠t t·ªïng phi·∫øu ƒë√£ nh·∫≠p
        function updateTotalEnteredVotes() {
            const type1Count = parseInt(document.getElementById('ballotType1Count').value) || 0;
            const type2Count = parseInt(document.getElementById('ballotType2Count').value) || 0;
            const type3Count = parseInt(document.getElementById('ballotType3Count').value) || 0;
            
            const totalEntered = type1Count + type2Count + type3Count;
            document.getElementById('totalEnteredVotes').textContent = totalEntered;
            
            const validVotes = parseInt(document.getElementById('validVotesCalc').textContent) || 0;
            const difference = totalEntered - validVotes;
            document.getElementById('voteDifference').textContent = difference;
            
            if (difference === 0) {
                document.getElementById('consistencyStatus').innerHTML = '<span style="color: green;">‚úì KH·ªöP</span>';
            } else if (difference > 0) {
                document.getElementById('consistencyStatus').innerHTML = '<span style="color: red;">‚úó D∆Ø ' + Math.abs(difference) + ' phi·∫øu</span>';
            } else {
                document.getElementById('consistencyStatus').innerHTML = '<span style="color: orange;">‚úó THI·∫æU ' + Math.abs(difference) + ' phi·∫øu</span>';
            }
        }

        // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng nh·∫≠p d·ªØ li·ªáu
        function onInputChange(type) {
            if (confirmedStatus[type]) {
                confirmedStatus[type] = false;
                const btn = document.getElementById('btn-' + type);
                btn.classList.remove('confirmed');
                btn.textContent = 'X√°c nh·∫≠n ƒë√£ nh·∫≠p xong';
            }
        }

        // X√°c nh·∫≠n d·ªØ li·ªáu t·ª´ng ph·∫ßn
        function checkVotes(type) {
            if (type === 'general') {
                savedData.general = {
                    totalVotersUnit: parseInt(document.getElementById('totalVotersUnit').value) || 0,
                    actualVoters: parseInt(document.getElementById('actualVoters').value) || 0,
                    issuedBallots: parseInt(document.getElementById('issuedBallots').value) || 0,
                    collectedBallots: parseInt(document.getElementById('collectedBallots').value) || 0,
                    invalidVotes: parseInt(document.getElementById('invalidVotes').value) || 0,
                    validVotes: parseInt(document.getElementById('validVotesCalc').textContent) || 0
                };
            } else if (type === 'type1') {
                candidateKeys.forEach(key => {
                    savedData.type1[key] = parseInt(document.getElementById(`vote_type1_${key}`).value) || 0;
                });
                savedData.type1.count = parseInt(document.getElementById('ballotType1Count').value) || 0;
            } else if (type === 'type2') {
                candidateKeys.forEach(key => {
                    savedData.type2[key] = parseInt(document.getElementById(`vote_type2_${key}`).value) || 0;
                });
                savedData.type2.count = parseInt(document.getElementById('ballotType2Count').value) || 0;
            } else if (type === 'type3') {
                pairs.forEach((pair, index) => {
                    savedData.type3[index] = parseInt(document.getElementById(`vote_type3_${index}`).value) || 0;
                });
                savedData.type3.count = parseInt(document.getElementById('ballotType3Count').value) || 0;
            }
            
            confirmedStatus[type] = true;
            const btn = document.getElementById('btn-' + type);
            btn.classList.add('confirmed');
            btn.textContent = '‚úì ƒê√£ x√°c nh·∫≠n';
            
            alert("ƒê√£ l∆∞u d·ªØ li·ªáu ph·∫ßn " + 
                  (type === 'general' ? 'Th√¥ng tin chung' : 
                   type === 'type1' ? 'B·∫ßu 1' : 
                   type === 'type2' ? 'B·∫ßu 2' : 'B·∫ßu 3'));
        }

        // T√≠nh to√°n k·∫øt qu·∫£ cu·ªëi c√πng
        function calculateTotalResults() {
            // Ki·ªÉm tra ƒë√£ x√°c nh·∫≠n t·∫•t c·∫£ ch∆∞a
            const allConfirmed = Object.values(confirmedStatus).every(status => status === true);
            if (!allConfirmed) {
                alert('Vui l√≤ng x√°c nh·∫≠n t·∫•t c·∫£ c√°c ph·∫ßn tr∆∞·ªõc khi t√≠nh to√°n!');
                return;
            }

            // Ki·ªÉm tra t√≠nh ƒë·ªìng nh·∫•t
            const validVotes = savedData.general.validVotes || 0;
            const totalEntered = (savedData.type1.count || 0) + (savedData.type2.count || 0) + (savedData.type3.count || 0);
            
            if (totalEntered !== validVotes) {
                if (!confirm(`S·ªë phi·∫øu 3 lo·∫°i (${totalEntered}) kh√¥ng kh·ªõp v·ªõi t·ªïng phi·∫øu h·ª£p l·ªá (${validVotes}). B·∫°n v·∫´n mu·ªën ti·∫øp t·ª•c?`)) {
                    return;
                }
            }

            // RESET k·∫øt qu·∫£
            finalResults = { 'A': 0, 'B': 0, 'C': 0, 'D': 0, 'E': 0 };

            // 1. C·ªông phi·∫øu t·ª´ ph·∫ßn B·∫¶U 1 (g·∫°ch 4)
            candidateKeys.forEach(key => {
                finalResults[key] += savedData.type1[key] || 0;
            });

            // 2. C·ªông phi·∫øu t·ª´ ph·∫ßn B·∫¶U 2 (g·∫°ch 3)
            candidateKeys.forEach(key => {
                finalResults[key] += savedData.type2[key] || 0;
            });

            // 3. T√≠nh phi·∫øu t·ª´ ph·∫ßn B·∫¶U 3 (g·∫°ch 2) - KI·ªÇM NG∆Ø·ª¢C
            pairs.forEach((pair, index) => {
                const rejectedVal = savedData.type3[index] || 0; // S·ªë phi·∫øu g·∫°ch c·∫∑p n√†y
                
                // M·ªói phi·∫øu g·∫°ch c·∫∑p n√†y = b·∫ßu 3 ng∆∞·ªùi c√≤n l·∫°i
                candidateKeys.forEach(id => {
                    if (!pair.ids.includes(id)) {
                        finalResults[id] += rejectedVal;
                    }
                });
            });

            // 4. Hi·ªÉn th·ªã k·∫øt qu·∫£
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';
            
            // T√≠nh t·ªïng s·ªë phi·∫øu b·∫ßu th·ª±c t·∫ø
            const totalVotesFromType1 = Object.values(savedData.type1).reduce((a, b) => (typeof b === 'number' ? a + b : a), 0);
            const totalVotesFromType2 = Object.values(savedData.type2).reduce((a, b) => (typeof b === 'number' ? a + b : a), 0);
            const totalVotesFromType3 = (savedData.type3.count || 0) * 3; // M·ªói phi·∫øu b·∫ßu 3 ng∆∞·ªùi
            
            const totalActualVotes = totalVotesFromType1 + totalVotesFromType2 + totalVotesFromType3;
            
            // S·∫Øp x·∫øp v√† hi·ªÉn th·ªã
            const sorted = Object.keys(finalResults).sort((a,b) => finalResults[b] - finalResults[a]);
            
            sorted.forEach((key, index) => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = candidates[key];
                row.insertCell(2).textContent = finalResults[key];
                
                // T√≠nh t·ª∑ l·ªá % so v·ªõi t·ªïng s·ªë phi·∫øu b·∫ßu th·ª±c t·∫ø
                const pct = totalActualVotes > 0 ? ((finalResults[key] / totalActualVotes) * 100).toFixed(2) : 0;
                row.insertCell(3).textContent = pct + '%';
            });
            
            // Th√™m d√≤ng t·ªïng
            const totalRow = tbody.insertRow();
            totalRow.style.backgroundColor = '#f5f5f5';
            totalRow.insertCell(0).textContent = '';
            totalRow.insertCell(1).innerHTML = '<strong>T·ªîNG C·ªòNG:</strong>';
            totalRow.insertCell(2).innerHTML = '<strong>' + Object.values(finalResults).reduce((a,b) => a + b, 0) + '</strong>';
            totalRow.insertCell(3).innerHTML = '<strong>100%</strong>';
            
            document.getElementById('totalResults').style.display = 'block';
            document.getElementById('totalResults').scrollIntoView({ behavior: 'smooth' });
        }

        // Xu·∫•t file Excel
        function exportToExcel() {
            // T·∫°o workbook
            const wb = XLSX.utils.book_new();

            // Sheet 1: B√°o c√°o t·ªïng h·ª£p
            const summaryData = [
                ['BI√äN B·∫¢N KI·ªÇM PHI·∫æU B·∫¶U C·ª¨ (5 B·∫¶U 3)'],
                ['Ng√†y xu·∫•t: ' + new Date().toLocaleString('vi-VN')],
                [],
                ['TH√îNG TIN B·∫¶U C·ª¨'],
                ['T·ªïng s·ªë c·ª≠ tri:', savedData.general.totalVotersUnit],
                ['S·ªë c·ª≠ tri ƒë√£ tham gia b·ªè phi·∫øu:', savedData.general.actualVoters],
                ['S·ªë phi·∫øu ph√°t ra:', savedData.general.issuedBallots],
                ['S·ªë phi·∫øu thu v√†o:', savedData.general.collectedBallots],
                ['S·ªë phi·∫øu h·ª£p l·ªá:', savedData.general.validVotes],
                ['S·ªë phi·∫øu kh√¥ng h·ª£p l·ªá:', savedData.general.invalidVotes],
                [],
                ['PH√ÇN LO·∫†I PHI·∫æU'],
                ['Phi·∫øu b·∫ßu 1 ng∆∞·ªùi (g·∫°ch 4):', savedData.type1.count],
                ['Phi·∫øu b·∫ßu 2 ng∆∞·ªùi (g·∫°ch 3):', savedData.type2.count],
                ['Phi·∫øu b·∫ßu 3 ng∆∞·ªùi (g·∫°ch 2):', savedData.type3.count],
                ['T·ªïng c·ªông:', (savedData.type1.count || 0) + (savedData.type2.count || 0) + (savedData.type3.count || 0)],
                [],
                ['K·∫æT QU·∫¢ B·∫¶U C·ª¨'],
                ['S·ªë phi·∫øu b·∫ßu cho m·ªói ng∆∞·ªùi ·ª©ng c·ª≠ nh∆∞ sau:'],
                []
            ];

            // Th√™m d·ªØ li·ªáu ·ª©ng vi√™n
            const sorted = Object.keys(finalResults).sort((a,b) => finalResults[b] - finalResults[a]);
            sorted.forEach((key, index) => {
                const totalVotesFromType1 = Object.values(savedData.type1).reduce((a, b) => (typeof b === 'number' ? a + b : a), 0);
                const totalVotesFromType2 = Object.values(savedData.type2).reduce((a, b) => (typeof b === 'number' ? a + b : a), 0);
                const totalVotesFromType3 = (savedData.type3.count || 0) * 3;
                const totalActualVotes = totalVotesFromType1 + totalVotesFromType2 + totalVotesFromType3;
                const pct = totalActualVotes > 0 ? ((finalResults[key] / totalActualVotes) * 100).toFixed(2) : 0;
                
                summaryData.push([
                    (index + 1) + '. ' + candidates[key],
                    finalResults[key] + ' phi·∫øu',
                    pct + '%'
                ]);
            });

            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            ws1['!cols'] = [{ wch: 40 }, { wch: 20 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws1, 'Bi√™n b·∫£n t·ªïng h·ª£p');

            // Sheet 2: Chi ti·∫øt b·∫ßu 1
            const detail1 = [
                ['CHI TI·∫æT PHI·∫æU B·∫¶U 1 NG∆Ø·ªúI (G·∫†CH 4)'],
                ['S·ªë phi·∫øu lo·∫°i n√†y: ' + (savedData.type1.count || 0)],
                [],
                ['STT', '·ª®ng vi√™n', 'S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu']
            ];
            candidateKeys.forEach((key, index) => {
                detail1.push([index + 1, candidates[key], savedData.type1[key] || 0]);
            });
            const ws2 = XLSX.utils.aoa_to_sheet(detail1);
            ws2['!cols'] = [{ wch: 5 }, { wch: 30 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws2, 'Chi ti·∫øt B·∫ßu 1');

            // Sheet 3: Chi ti·∫øt b·∫ßu 2
            const detail2 = [
                ['CHI TI·∫æT PHI·∫æU B·∫¶U 2 NG∆Ø·ªúI (G·∫†CH 3)'],
                ['S·ªë phi·∫øu lo·∫°i n√†y: ' + (savedData.type2.count || 0)],
                [],
                ['STT', '·ª®ng vi√™n', 'S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu']
            ];
            candidateKeys.forEach((key, index) => {
                detail2.push([index + 1, candidates[key], savedData.type2[key] || 0]);
            });
            const ws3 = XLSX.utils.aoa_to_sheet(detail2);
            ws3['!cols'] = [{ wch: 5 }, { wch: 30 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws3, 'Chi ti·∫øt B·∫ßu 2');

            // Sheet 4: Chi ti·∫øt b·∫ßu 3
            const detail3 = [
                ['CHI TI·∫æT PHI·∫æU B·∫¶U 3 NG∆Ø·ªúI (G·∫†CH 2)'],
                ['S·ªë phi·∫øu lo·∫°i n√†y: ' + (savedData.type3.count || 0)],
                [],
                ['STT', 'C·∫∑p b·ªã g·∫°ch', 'S·ªë phi·∫øu']
            ];
            pairs.forEach((pair, index) => {
                const names = pair.ids.map(id => candidates[id]).join(' v√† ');
                detail3.push([index + 1, names, savedData.type3[index] || 0]);
            });
            const ws4 = XLSX.utils.aoa_to_sheet(detail3);
            ws4['!cols'] = [{ wch: 5 }, { wch: 35 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws4, 'Chi ti·∫øt B·∫ßu 3');

            // Xu·∫•t file
            const fileName = `Bien_ban_kiem_phieu_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert('ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!');
        }
    </script>
</body>
</html>
