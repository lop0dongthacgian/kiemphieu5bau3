<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ki·ªÉm phi·∫øu b·∫ßu c·ª≠ 5 b·∫ßu 3</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background-color: #f0f2f5; }
.container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
h1 { color: #1E29FF; text-align: center; }
h2 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 5px; text-align: center; }
h3 { color: #1a237e; margin-top: 20px; padding: 10px; background-color: #e3f2fd; border-radius: 5px; }
table { width: 100%; border-collapse: collapse; margin: 15px 0; }
th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
th { background-color: #f8f9fa; }
input[type="number"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
button { padding: 10px 20px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 4px; font-weight: bold; transition: background-color 0.3s; }
button:hover { background-color: #45a049; }
button.confirmed { background-color: #808080; }
button.confirmed:hover { background-color: #707070; }
.vote-table { margin: 20px 0; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; }
.check-type { background-color: #e7f3ff; padding: 10px; margin-bottom: 10px; border-left: 2px solid #2196F3; border-right: 2px solid #2196F3; font-weight: bold; }
.error-message { color: #d32f2f; background-color: #ffebee; padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
.summary { background-color: #e9f7ef; padding: 20px; border-radius: 8px; margin-top: 30px; }
.btn-center { text-align: center; margin-top: 15px; }
.combined-table td { text-align: center; }
.combined-table input { text-align: center; }
.export-btn { background-color: #28a745; margin-top: 20px; padding: 15px 30px; font-size: 16px; }
.export-btn:hover { background-color: #218838; }
.export-btn:disabled { background-color: #ccc; cursor: not-allowed; }
.section-counter { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.counter-box { background: #f5f5f5; padding: 10px 15px; border-radius: 5px; font-weight: bold; color: #333; }
.total-box { background: #e8f5e9; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: center; font-weight: bold; }
.logic-status { padding: 8px; margin-top: 5px; border-radius: 4px; font-weight: bold; text-align: center; }
.logic-ok { background-color: #e8f5e9; color: #2e7d32; }
.logic-error { background-color: #ffebee; color: #c62828; }
</style>
</head>
<body>
<div class="container">
<h1>M√ÅY T√çNH KI·ªÇM PHI·∫æU B·∫¶U C·ª¨ (5 B·∫¶U 3)</h1>

<!-- TH√îNG TIN CHUNG -->
<div class="vote-table">
<h2>TH√îNG TIN CHUNG</h2>
<table>
<tr>
<td><strong>T·ªïng s·ªë c·ª≠ tri:</strong></td>
<td><input type="number" id="totalVotersUnit" value="" oninput="onInputChange('general')"></td><td><strong>S·ªë c·ª≠ tri tham gia b·ªè phi·∫øu:</strong></td>
<td><input type="number" id="actualVoters" value="" oninput="updateCalculations(); onInputChange('general')"></td>
</tr>
<tr>
<td colspan="3"><strong>T·ª∑ l·ªá c·ª≠ tri tham gia:</strong></td>
<td><strong id="voterTurnout" style="color: blue;">0%</strong></td>
</tr>
<tr>
<td><strong>S·ªë phi·∫øu ph√°t ra:</strong></td>
<td><input type="number" id="issuedBallots" value="" oninput="onInputChange('general')"></td>
<td><strong>S·ªë phi·∫øu thu v√†o:</strong></td>
<td><input type="number" id="collectedBallots" value="" oninput="updateCalculations(); onInputChange('general')"></td>
</tr>
<tr>
<td><strong>S·ªë phi·∫øu kh√¥ng h·ª£p l·ªá:</strong></td>
<td><input type="number" id="invalidVotes" value="" oninput="updateCalculations(); onInputChange('general')"></td>
<td><strong>S·ªë phi·∫øu h·ª£p l·ªá:</strong></td>
<td><strong id="validVotesCalc" style="color: green;">0</strong></td>
</tr>
<tr>
<td colspan="3"><strong>T·ª∑ l·ªá phi·∫øu h·ª£p l·ªá:</strong></td>
<td><strong id="validVotesRate" style="color: green;">0%</strong></td>
</tr>
<tr>
<td colspan="3"><strong>T·ª∑ l·ªá phi·∫øu kh√¥ng h·ª£p l·ªá:</strong></td>
<td><strong id="invalidVotesRate" style="color: red;">0%</strong></td>
</tr>
</table>
<div class="btn-center">
<button id="btn-general" onclick="checkVotes('general')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button>
</div>
</div>

<!-- B·∫¶U 1 -->
<div class="vote-table">
<div class="section-counter">
<h3>PHI·∫æU B·∫¶U 1 NG∆Ø·ªúI (G·∫†CH 4)</h3>
<div class="counter-box">
S·ªë phi·∫øu lo·∫°i n√†y: <input type="number" id="ballotType1Count" value="" style="width: 80px; margin-left: 10px;" oninput="updateType1Logic(); onInputChange('type1')">
</div>
</div>
<div class="check-type">Nh·∫≠p s·ªë phi·∫øu ƒê∆Ø·ª¢C B·∫¶U cho t·ª´ng ng∆∞·ªùi (m·ªói phi·∫øu ch·ªâ b·∫ßu 1 ng∆∞·ªùi)</div>
<table class="combined-table">
<thead><tr><th>STT</th><th>Ng∆∞·ªùi ƒë∆∞·ª£c b·∫ßu</th><th>S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu</th></tr></thead>
<tbody id="body-type1"></tbody>
</table>
<div class="total-box">T·ªïng phi·∫øu b·∫ßu lo·∫°i n√†y: <span id="type1Sum">0</span></div>
<div id="logic-type1" class="logic-status"></div>
<div class="btn-center">
<button id="btn-type1" onclick="checkVotes('type1')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button></div>
</div>

<!-- B·∫¶U 2 -->
<div class="vote-table">
<div class="section-counter">
<h3>PHI·∫æU B·∫¶U 2 NG∆Ø·ªúI (G·∫†CH 3)</h3>
<div class="counter-box">
S·ªë phi·∫øu lo·∫°i n√†y: <input type="number" id="ballotType2Count" value="" style="width: 80px; margin-left: 10px;" oninput="updateType2Logic(); onInputChange('type2')">
</div>
</div>
<div class="check-type">Nh·∫≠p s·ªë phi·∫øu ƒê∆Ø·ª¢C B·∫¶U cho t·ª´ng ng∆∞·ªùi (m·ªói phi·∫øu b·∫ßu 2 ng∆∞·ªùi)</div>
<table class="combined-table">
<thead><tr><th>STT</th><th>Ng∆∞·ªùi ƒë∆∞·ª£c b·∫ßu</th><th>S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu</th></tr></thead>
<tbody id="body-type2"></tbody>
</table>
<div class="total-box">T·ªïng phi·∫øu b·∫ßu lo·∫°i n√†y: <span id="type2Sum">0</span> (l√Ω thuy·∫øt: <span id="type2Expected">0</span>)</div>
<div id="logic-type2" class="logic-status"></div>
<div class="btn-center">
<button id="btn-type2" onclick="checkVotes('type2')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button>
</div>
</div>

<!-- B·∫¶U 3 -->
<div class="vote-table">
<div class="section-counter">
<h3>PHI·∫æU B·∫¶U 3 NG∆Ø·ªúI (G·∫†CH 2)</h3>
<div class="counter-box">
S·ªë phi·∫øu lo·∫°i n√†y: <input type="number" id="ballotType3Count" value="" style="width: 80px; margin-left: 10px;" oninput="updateType3Logic(); onInputChange('type3')">
</div>
</div>
<div class="check-type">Nh·∫≠p s·ªë phi·∫øu theo c·∫∑p B·ªä G·∫†CH (m·ªói phi·∫øu g·∫°ch 2 ng∆∞·ªùi, b·∫ßu 3 ng∆∞·ªùi c√≤n l·∫°i)</div>
<table id="table-type3">
<thead><tr><th>STT</th><th>C·∫∑p ·ª©ng vi√™n B·ªä G·∫†CH</th><th>S·ªë phi·∫øu</th></tr></thead>
<tbody id="body-type3"></tbody>
</table>
<div id="logic-type3" class="logic-status"></div>
<div class="btn-center">
<button id="btn-type3" onclick="checkVotes('type3')">X√°c nh·∫≠n ƒë√£ nh·∫≠p xong</button>
</div>
</div>

<!-- T·ªîNG H·ª¢P T·∫†M -->
<div class="vote-table" style="background-color: #fff8e1;">
<h2>T·ªîNG H·ª¢P T·∫†M TH·ªúI</h2>
<table>
<tr><td><strong>T·ªïng phi·∫øu h·ª£p l·ªá:</strong></td><td><strong id="totalValidVotes" style="color: blue;">0</strong></td></tr>
<tr><td><strong>T·ªïng phi·∫øu 3 lo·∫°i ƒë√£ nh·∫≠p:</strong></td><td><strong id="totalEnteredVotes" style="color: green;">0</strong></td></tr>
<tr><td><strong>Ch√™nh l·ªách:</strong></td><td><strong id="voteDifference" style="color: red;">0</strong></td></tr>
<tr><td><strong>Tr·∫°ng th√°i:</strong></td><td><strong id="consistencyStatus">Ch∆∞a ki·ªÉm tra</strong></td></tr></table>
</div>

<!-- N√öT T√çNH TO√ÅN -->
<div style="text-align: center; margin: 40px 0;">
<button onclick="calculateTotalResults()" style="background-color: #1E29FF; font-size: 15px; padding: 20px 40px;">
<span style="font-size: 16px; font-weight: bold;">T√çNH TO√ÅN K·∫æT QU·∫¢ CU·ªêI C√ôNG</span><br>
<span style="font-size: 12px;">(Sau khi ƒë√£ x√°c nh·∫≠n xong t·∫•t c·∫£ c√°c ph·∫ßn)</span>
</button>
</div>

<!-- K·∫æT QU·∫¢ CU·ªêI -->
<div id="totalResults" class="summary" style="display: none;">
<h2>K·∫æT QU·∫¢ T·ªîNG H·ª¢P CU·ªêI C√ôNG</h2>
<table id="resultsTable">
<thead><tr><th>STT</th><th>·ª®ng vi√™n</th><th>S·ªë phi·∫øu ƒê∆Ø·ª¢C B·∫¶U</th><th>T·ª∑ l·ªá (%)</th></tr></thead>
<tbody></tbody>
</table>
<div class="btn-center">
<button class="export-btn" onclick="exportToExcel()">üìä XU·∫§T K·∫æT QU·∫¢ RA FILE EXCEL</button>
</div>
</div>
</div>

<script src="config.js"></script>

<script>
const pairs = [
{ids: ['A','B']}, {ids: ['A','C']}, {ids: ['A','D']}, {ids: ['A','E']},
{ids: ['B','C']}, {ids: ['B','D']}, {ids: ['B','E']},
{ids: ['C','D']}, {ids: ['C','E']}, {ids: ['D','E']}
];

let confirmedStatus = {'general': false, 'type1': false, 'type2': false, 'type3': false};
let savedData = {'general': {}, 'type1': {}, 'type2': {}, 'type3': {}};
let finalResults = {};

window.onload = function() {
	const body1 = document.getElementById('body-type1');
	candidateKeys.forEach((key, i) => {
		body1.innerHTML += `<tr><td>${i+1}</td><td>${candidates[key]}</td><td><input type="number" id="vote_type1_${key}" value="" oninput="updateType1Logic(); onInputChange('type1')"></td></tr>`;
	});
	const body2 = document.getElementById('body-type2');
	candidateKeys.forEach((key, i) => {		body2.innerHTML += `<tr><td>${i+1}</td><td>${candidates[key]}</td><td><input type="number" id="vote_type2_${key}" value="" oninput="updateType2Logic(); onInputChange('type2')"></td></tr>`;
	});
	const body3 = document.getElementById('body-type3');
	pairs.forEach((pair, i) => {
		const names = pair.ids.map(id => candidates[id]).join(' v√† ');
		body3.innerHTML += `<tr><td>${i+1}</td><td>${names}</td><td><input type="number" id="vote_type3_${i}" value="" oninput="updateType3Logic(); onInputChange('type3')"></td></tr>`;
	});
	updateCalculations();
};

function updateType1Logic() {
	const count = parseInt(document.getElementById('ballotType1Count').value) || 0;
	let sum = 0;
	candidateKeys.forEach(k => sum += parseInt(document.getElementById(`vote_type1_${k}`).value) || 0);
	document.getElementById('type1Sum').textContent = sum;
	const el = document.getElementById('logic-type1');
	if (count === 0 && sum === 0) {
		el.className = 'logic-status'; el.textContent = '';
	} else if (sum === count) {
		el.className = 'logic-status logic-ok'; el.textContent = '‚úì H·ª£p l·ªá: T·ªïng phi·∫øu = s·ªë phi·∫øu lo·∫°i n√†y';
	} else {
		el.className = 'logic-status logic-error'; el.textContent = `‚úó Kh√¥ng h·ª£p l·ªá: T·ªïng phi·∫øu (${sum}) ‚â† s·ªë phi·∫øu lo·∫°i n√†y (${count})`;
	}
	updateTotalEnteredVotes();
}

function updateType2Logic() {
	const count = parseInt(document.getElementById('ballotType2Count').value) || 0;
	let sum = 0;
	candidateKeys.forEach(k => sum += parseInt(document.getElementById(`vote_type2_${k}`).value) || 0);
	document.getElementById('type2Sum').textContent = sum;
	const expected = count * 2;
	document.getElementById('type2Expected').textContent = expected;
	const el = document.getElementById('logic-type2');
	if (count === 0 && sum === 0) {
		el.className = 'logic-status'; el.textContent = '';
	} else if (sum === expected) {
		el.className = 'logic-status logic-ok'; el.textContent = '‚úì H·ª£p l·ªá: T·ªïng phi·∫øu = 2 √ó s·ªë phi·∫øu lo·∫°i n√†y';
	} else {
		el.className = 'logic-status logic-error'; el.textContent = `‚úó Kh√¥ng h·ª£p l·ªá: T·ªïng phi·∫øu (${sum}) ‚â† 2 √ó s·ªë phi·∫øu lo·∫°i n√†y (${expected})`;
	}
	updateTotalEnteredVotes();
}

function updateType3Logic() {
	const count = parseInt(document.getElementById('ballotType3Count').value) || 0;
	let sum = 0;
	pairs.forEach((_, i) => sum += parseInt(document.getElementById(`vote_type3_${i}`).value) || 0);
	const el = document.getElementById('logic-type3');
	if (count === 0 && sum === 0) {		el.className = 'logic-status'; el.textContent = '';
	} else if (sum === count) {
		el.className = 'logic-status logic-ok'; el.textContent = '‚úì H·ª£p l·ªá: T·ªïng phi·∫øu g·∫°ch = s·ªë phi·∫øu lo·∫°i n√†y';
	} else {
		el.className = 'logic-status logic-error'; el.textContent = `‚úó Kh√¥ng h·ª£p l·ªá: T·ªïng phi·∫øu g·∫°ch (${sum}) ‚â† s·ªë phi·∫øu lo·∫°i n√†y (${count})`;
	}
	updateTotalEnteredVotes();
}

function updateCalculations() {
	const totalVoters = parseInt(document.getElementById('totalVotersUnit').value) || 0;
	const actual = parseInt(document.getElementById('actualVoters').value) || 0;
	const collected = parseInt(document.getElementById('collectedBallots').value) || 0;
	const invalid = parseInt(document.getElementById('invalidVotes').value) || 0;
	const valid = Math.max(0, collected - invalid);
	document.getElementById('validVotesCalc').textContent = valid;
	document.getElementById('totalValidVotes').textContent = valid;
	document.getElementById('voterTurnout').textContent = (totalVoters > 0 ? ((actual / totalVoters) * 100).toFixed(2) : 0) + '%';
	document.getElementById('validVotesRate').textContent = (collected > 0 ? ((valid / collected) * 100).toFixed(2) : 0) + '%';
	document.getElementById('invalidVotesRate').textContent = (collected > 0 ? ((invalid / collected) * 100).toFixed(2) : 0) + '%';
	updateTotalEnteredVotes();
}

function updateTotalEnteredVotes() {
	const t1 = parseInt(document.getElementById('ballotType1Count').value) || 0;
	const t2 = parseInt(document.getElementById('ballotType2Count').value) || 0;
	const t3 = parseInt(document.getElementById('ballotType3Count').value) || 0;
	const total = t1 + t2 + t3;
	const valid = parseInt(document.getElementById('validVotesCalc').textContent) || 0;
	document.getElementById('totalEnteredVotes').textContent = total;
	document.getElementById('voteDifference').textContent = total - valid;
	const statusEl = document.getElementById('consistencyStatus');
	if (total === valid) {
		statusEl.innerHTML = '<span style="color:green;">‚úì KH·ªöP</span>';
	} else if (total > valid) {
		statusEl.innerHTML = `<span style="color:red;">‚úó D∆Ø ${total - valid} phi·∫øu</span>`;
	} else {
		statusEl.innerHTML = `<span style="color:orange;">‚úó THI·∫æU ${valid - total} phi·∫øu</span>`;
	}
}

function onInputChange(type) {
	if (confirmedStatus[type]) {
		confirmedStatus[type] = false;
		const btn = document.getElementById('btn-' + type);
		btn.classList.remove('confirmed');
		btn.textContent = 'X√°c nh·∫≠n ƒë√£ nh·∫≠p xong';
	}
}
function checkVotes(type) {
	if (type === 'general') {
		savedData.general = {
			totalVotersUnit: parseInt(document.getElementById('totalVotersUnit').value) || 0,
			actualVoters: parseInt(document.getElementById('actualVoters').value) || 0,
			issuedBallots: parseInt(document.getElementById('issuedBallots').value) || 0,
			collectedBallots: parseInt(document.getElementById('collectedBallots').value) || 0,
			invalidVotes: parseInt(document.getElementById('invalidVotes').value) || 0,
			validVotes: parseInt(document.getElementById('validVotesCalc').textContent) || 0
		};
	} else if (type === 'type1') {
		candidateKeys.forEach(k => savedData.type1[k] = parseInt(document.getElementById(`vote_type1_${k}`).value) || 0);
		savedData.type1.count = parseInt(document.getElementById('ballotType1Count').value) || 0;
	} else if (type === 'type2') {
		candidateKeys.forEach(k => savedData.type2[k] = parseInt(document.getElementById(`vote_type2_${k}`).value) || 0);
		savedData.type2.count = parseInt(document.getElementById('ballotType2Count').value) || 0;
	} else if (type === 'type3') {
		pairs.forEach((_, i) => savedData.type3[i] = parseInt(document.getElementById(`vote_type3_${i}`).value) || 0);
		savedData.type3.count = parseInt(document.getElementById('ballotType3Count').value) || 0;
	}
	confirmedStatus[type] = true;
	const btn = document.getElementById('btn-' + type);
	btn.classList.add('confirmed');
	btn.textContent = '‚úì ƒê√£ x√°c nh·∫≠n';
	alert("ƒê√£ l∆∞u d·ªØ li·ªáu ph·∫ßn " + (type === 'general' ? 'Th√¥ng tin chung' : type === 'type1' ? 'B·∫ßu 1' : type === 'type2' ? 'B·∫ßu 2' : 'B·∫ßu 3'));
}

function calculateTotalResults() {
	if (!Object.values(confirmedStatus).every(v => v)) {
		alert('Vui l√≤ng x√°c nh·∫≠n t·∫•t c·∫£ c√°c ph·∫ßn tr∆∞·ªõc khi t√≠nh to√°n!');
		return;
	}
	const validVotes = savedData.general.validVotes || 0;
	const totalEntered = (savedData.type1.count || 0) + (savedData.type2.count || 0) + (savedData.type3.count || 0);
	if (totalEntered !== validVotes) {
		if (!confirm(`S·ªë phi·∫øu ƒë√£ nh·∫≠p (${totalEntered}) ‚â† t·ªïng phi·∫øu h·ª£p l·ªá (${validVotes}). Ti·∫øp t·ª•c?`)) return;
	}
	finalResults = {'A':0,'B':0,'C':0,'D':0,'E':0};
	candidateKeys.forEach(k => {
		finalResults[k] += savedData.type1[k] || 0;
		finalResults[k] += savedData.type2[k] || 0;
	});
	pairs.forEach((pair, i) => {
		const val = savedData.type3[i] || 0;
		candidateKeys.forEach(id => {
			if (!pair.ids.includes(id)) finalResults[id] += val;
		});
	});
	const tbody = document.querySelector('#resultsTable tbody');
	tbody.innerHTML = '';	const sorted = Object.keys(finalResults).sort((a,b) => finalResults[b] - finalResults[a]);
	sorted.forEach((k, idx) => {
		const row = tbody.insertRow();
		row.insertCell(0).textContent = idx + 1;
		row.insertCell(1).textContent = candidates[k];
		row.insertCell(2).textContent = finalResults[k];
		const pct = validVotes > 0 ? ((finalResults[k] / validVotes) * 100).toFixed(2) : 0;
		row.insertCell(3).textContent = pct + '%';
	});
	const totalRow = tbody.insertRow();
	totalRow.style.backgroundColor = '#f5f5f5';
	totalRow.insertCell(0).textContent = '';
	totalRow.insertCell(1).innerHTML = '<strong>T·ªîNG C·ªòNG:</strong>';
	totalRow.insertCell(2).innerHTML = '<strong>' + Object.values(finalResults).reduce((a,b)=>a+b,0) + '</strong>';
	totalRow.insertCell(3).innerHTML = '<strong>100%</strong>';
	document.getElementById('totalResults').style.display = 'block';
}

function exportToExcel() {
	const wb = XLSX.utils.book_new();
	const validVotes = savedData.general.validVotes || 0;
	const collectedBallots = savedData.general.collectedBallots || 0;
	const totalVoters = savedData.general.totalVotersUnit || 0;
	const actualVoters = savedData.general.actualVoters || 0;

	// T√≠nh t·ª∑ l·ªá an to√†n (tr√°nh chia cho 0)
	const turnoutPct = totalVoters > 0 ? ((actualVoters / totalVoters) * 100).toFixed(2) : 0;
	const validRate = collectedBallots > 0 ? ((validVotes / collectedBallots) * 100).toFixed(2) : 0;
	const invalidVotes = collectedBallots - validVotes;
	const invalidRate = collectedBallots > 0 ? ((invalidVotes / collectedBallots) * 100).toFixed(2) : 0;

	const summaryData = [
		['BI√äN B·∫¢N KI·ªÇM PHI·∫æU B·∫¶U C·ª¨ (5 B·∫¶U 3)'],
		['Ng√†y xu·∫•t: ' + new Date().toLocaleString('vi-VN')],
		[],
		['TH√îNG TIN B·∫¶U C·ª¨'],
		['S·ªë c·ª≠ tri ƒë√£ tham gia b·ªè phi·∫øu:', actualVoters + ' ng∆∞·ªùi'],
		['T·ª∑ l·ªá c·ª≠ tri ƒë√£ tham gia b·ªè phi·∫øu so v·ªõi t·ªïng s·ªë c·ª≠ tri c·ªßa ƒë∆°n v·ªã b·∫ßu c·ª≠:', turnoutPct + '%'],
		['S·ªë phi·∫øu ph√°t ra:', savedData.general.issuedBallots + ' phi·∫øu'],
		['S·ªë phi·∫øu thu v√†o:', collectedBallots + ' phi·∫øu'],
		['S·ªë phi·∫øu h·ª£p l·ªá:', validVotes + ' phi·∫øu. T·ª∑ l·ªá so v·ªõi t·ªïng s·ªë phi·∫øu thu v√†o: ' + validRate + '%'],
		['S·ªë phi·∫øu kh√¥ng h·ª£p l·ªá:', invalidVotes + ' phi·∫øu. T·ª∑ l·ªá so v·ªõi t·ªïng s·ªë phi·∫øu thu v√†o: ' + invalidRate + '%'],
		[],
		['S·ªê PHI·∫æU B·∫¶U CHO M·ªñI NG∆Ø·ªúI ·ª®NG C·ª¨ NH∆Ø SAU:']
	];

	// S·∫Øp x·∫øp k·∫øt qu·∫£ theo s·ªë phi·∫øu gi·∫£m d·∫ßn
	const sorted = Object.keys(finalResults).sort((a, b) => finalResults[b] - finalResults[a]);

	sorted.forEach((key, index) => {
		const votes = finalResults[key];
		const pctOfValid = validVotes > 0 ? ((votes / validVotes) * 100).toFixed(2) : 0;
		const title = candidates[key].startsWith('Nguy·ªÖn') ||
		              candidates[key].startsWith('Tr·∫ßn') ||
		              candidates[key].startsWith('L√™') ||
		              candidates[key].startsWith('Ho√†ng') ||
		              candidates[key].startsWith('B√πi')
			? '√îng/B√†'
			: '√îng/B√†'; // C√≥ th·ªÉ m·ªü r·ªông danh s√°ch h·ªç n·∫øu c·∫ßn
		summaryData.push([
			(index + 1) + '. ' + title + ' ' + candidates[key] + ' ƒë∆∞·ª£c ' + votes + ' phi·∫øu, ' + pctOfValid + '%/phi·∫øu h·ª£p l·ªá'
		]);
	});

	const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
	ws1['!cols'] = [{ wch: 80 }];
	XLSX.utils.book_append_sheet(wb, ws1, 'Bi√™n b·∫£n t·ªïng h·ª£p');

	// C√°c sheet chi ti·∫øt (gi·ªØ nguy√™n nh∆∞ c≈©)
	const detail1 = [
		['CHI TI·∫æT PHI·∫æU B·∫¶U 1 NG∆Ø·ªúI (G·∫†CH 4)'],
		['S·ªë phi·∫øu lo·∫°i n√†y: ' + (savedData.type1.count || 0)],
		[],
		['STT', '·ª®ng vi√™n', 'S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu']
	];
	candidateKeys.forEach((key, index) => {
		detail1.push([index + 1, candidates[key], savedData.type1[key] || 0]);
	});
	const ws2 = XLSX.utils.aoa_to_sheet(detail1);
	ws2['!cols'] = [{ wch: 5 }, { wch: 30 }, { wch: 20 }];
	XLSX.utils.book_append_sheet(wb, ws2, 'Chi ti·∫øt B·∫ßu 1');

	const detail2 = [
		['CHI TI·∫æT PHI·∫æU B·∫¶U 2 NG∆Ø·ªúI (G·∫†CH 3)'],
		['S·ªë phi·∫øu lo·∫°i n√†y: ' + (savedData.type2.count || 0)],
		[],
		['STT', '·ª®ng vi√™n', 'S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu']
	];
	candidateKeys.forEach((key, index) => {
		detail2.push([index + 1, candidates[key], savedData.type2[key] || 0]);
	});
	const ws3 = XLSX.utils.aoa_to_sheet(detail2);
	ws3['!cols'] = [{ wch: 5 }, { wch: 30 }, { wch: 20 }];
	XLSX.utils.book_append_sheet(wb, ws3, 'Chi ti·∫øt B·∫ßu 2');

	const detail3 = [
		['CHI TI·∫æT PHI·∫æU B·∫¶U 3 NG∆Ø·ªúI (G·∫†CH 2)'],
		['S·ªë phi·∫øu lo·∫°i n√†y: ' + (savedData.type3.count || 0)],
		[],
		['STT', 'C·∫∑p b·ªã g·∫°ch', 'S·ªë phi·∫øu']
	];
	pairs.forEach((pair, index) => {
		const names = pair.ids.map(id => candidates[id]).join(' v√† ');
		detail3.push([index + 1, names, savedData.type3[index] || 0]);
	});
	const ws4 = XLSX.utils.aoa_to_sheet(detail3);
	ws4['!cols'] = [{ wch: 5 }, { wch: 35 }, { wch: 15 }];
	XLSX.utils.book_append_sheet(wb, ws4, 'Chi ti·∫øt B·∫ßu 3');

	const fileName = `Bien_ban_kiem_phieu_${new Date().toISOString().slice(0,10)}.xlsx`;
	XLSX.writeFile(wb, fileName);
	alert('ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!');
}
</script>
</body>
</html>
